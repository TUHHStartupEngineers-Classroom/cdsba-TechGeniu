{
  "hash": "1a6170b4f936ba705e7b2371d3329ffe",
  "result": {
    "markdown": "---\ntitle: \"Matching and Subclassification\"\nauthor: \"Sriramkumar Sarida\"\n---\n\n\n# Membership effect on Sales\n\n------------------------------------------------------------------------\n\n## Load the data frame\n\n\n::: {.cell hash='07_matching_cache/html/unnamed-chunk-1_d9cb36fdcdb874a0f710017ca3ed414d'}\n\n```{.r .cell-code}\nmembership  <- readRDS(\"../../data/membership.rds\")\n```\n:::\n\n::: {.cell hash='07_matching_cache/html/unnamed-chunk-2_19c30300a874d57b19d9e5e99b93fa20'}\n\n```{.r .cell-code}\nhead(membership)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"age\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"sex\"],\"name\":[2],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"pre_avg_purch\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"card\"],\"name\":[4],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"avg_purch\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"31.3\",\"2\":\"1\",\"3\":\"61.14632\",\"4\":\"0\",\"5\":\"70.77889\"},{\"1\":\"40.7\",\"2\":\"1\",\"3\":\"42.96728\",\"4\":\"1\",\"5\":\"51.36155\"},{\"1\":\"23.2\",\"2\":\"1\",\"3\":\"18.00792\",\"4\":\"1\",\"5\":\"25.96521\"},{\"1\":\"65.3\",\"2\":\"0\",\"3\":\"81.97980\",\"4\":\"1\",\"5\":\"123.99519\"},{\"1\":\"27.2\",\"2\":\"0\",\"3\":\"61.43390\",\"4\":\"0\",\"5\":\"45.12074\"},{\"1\":\"52.4\",\"2\":\"1\",\"3\":\"90.28035\",\"4\":\"0\",\"5\":\"113.26259\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n## DAG Diagram\n\n\n::: {.cell hash='07_matching_cache/html/unnamed-chunk-3_ca2b0e87720412a2cc859a416278d74a'}\n\n```{.r .cell-code}\n# Assuming you have the ggdag package installed\nlibrary(ggdag)\nlibrary(ggplot2)\n\n# Define the DAG\ndag <- dagify(\n  X ~ Z,\n  Y ~ Z,\n  Y ~ X,\n  coords = list(x = c(Y = 3, Z = 2, X = 1),\n                y = c(Y = 0, Z = 1, X = 0)),\n  labels = list(X = \"card\",\n                Y = \"avg_purch\",\n                Z = \"pre_avg_purch\")\n)\n\nggdag(dag) +\n  theme_dag() + \n  geom_dag_point() +\n  geom_dag_text() +\n  geom_dag_edges() +\n  geom_dag_label_repel(aes(label = label))\n```\n\n::: {.cell-output-display}\n![](07_matching_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n## Compute Naive Estimate of ATE\n\n\n::: {.cell hash='07_matching_cache/html/unnamed-chunk-4_956299173c3b4f0c65407a2198d81e69'}\n\n```{.r .cell-code}\nnaive_model <- lm(avg_purch ~ card + age + sex + pre_avg_purch, data = membership)\nsummary(naive_model)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> \n#> Call:\n#> lm(formula = avg_purch ~ card + age + sex + pre_avg_purch, data = membership)\n#> \n#> Residuals:\n#>     Min      1Q  Median      3Q     Max \n#> -54.184 -10.206   0.022  10.003  62.115 \n#> \n#> Coefficients:\n#>                Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept)   -0.173970   0.542953  -0.320    0.749    \n#> card          14.910946   0.314135  47.467   <2e-16 ***\n#> age            0.014427   0.013222   1.091    0.275    \n#> sex            0.076991   0.304649   0.253    0.800    \n#> pre_avg_purch  0.991921   0.006784 146.213   <2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Residual standard error: 15.23 on 9995 degrees of freedom\n#> Multiple R-squared:  0.7817,\tAdjusted R-squared:  0.7816 \n#> F-statistic:  8948 on 4 and 9995 DF,  p-value: < 2.2e-16\n```\n:::\n:::\n\n\n## Apply Coarsed Matching Method\n\n\n::: {.cell hash='07_matching_cache/html/unnamed-chunk-5_1f08c88c1d4c4d2454b07f6ebfafeabd'}\n\n```{.r .cell-code}\nlibrary(MatchIt)\nmatch_cem <- matchit(card ~ sex + age + pre_avg_purch, data = membership, method = \"cem\")\nsummary(match_cem)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> \n#> Call:\n#> matchit(formula = card ~ sex + age + pre_avg_purch, data = membership, \n#>     method = \"cem\")\n#> \n#> Summary of Balance for All Data:\n#>               Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean\n#> sex                  0.5087        0.5002          0.0171          .    0.0086\n#> age                 42.0331       39.1574          0.2064     1.1524    0.0438\n#> pre_avg_purch       76.3938       66.0438          0.3936     1.0276    0.1092\n#>               eCDF Max\n#> sex             0.0086\n#> age             0.0864\n#> pre_avg_purch   0.1545\n#> \n#> Summary of Balance for Matched Data:\n#>               Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean\n#> sex                  0.5070        0.5070          0.0000          .    0.0000\n#> age                 41.6786       41.6527          0.0019     0.9995    0.0016\n#> pre_avg_purch       75.7076       75.3560          0.0134     0.9951    0.0042\n#>               eCDF Max Std. Pair Dist.\n#> sex             0.0000          0.0000\n#> age             0.0070          0.1181\n#> pre_avg_purch   0.0128          0.1547\n#> \n#> Sample Sizes:\n#>               Control Treated\n#> All            5768.     4232\n#> Matched (ESS)  4407.4    4164\n#> Matched        5716.     4164\n#> Unmatched        52.       68\n#> Discarded         0.        0\n```\n:::\n\n```{.r .cell-code}\ndata_cem <- match.data(match_cem)\nsummary(data_cem)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#>       age             sex        pre_avg_purch          card       \n#>  Min.   :16.00   Min.   :0.000   Min.   : -1.791   Min.   :0.0000  \n#>  1st Qu.:29.80   1st Qu.:0.000   1st Qu.: 51.859   1st Qu.:0.0000  \n#>  Median :38.60   Median :1.000   Median : 69.983   Median :0.0000  \n#>  Mean   :40.17   Mean   :0.504   Mean   : 70.242   Mean   :0.4215  \n#>  3rd Qu.:48.90   3rd Qu.:1.000   3rd Qu.: 88.375   3rd Qu.:1.0000  \n#>  Max.   :84.60   Max.   :1.000   Max.   :153.713   Max.   :1.0000  \n#>                                                                    \n#>    avg_purch         weights           subclass   \n#>  Min.   :-28.61   Min.   : 0.1615   5      : 148  \n#>  1st Qu.: 54.08   1st Qu.: 0.8527   94     : 142  \n#>  Median : 76.11   Median : 1.0000   4      : 141  \n#>  Mean   : 76.39   Mean   : 1.0000   80     : 140  \n#>  3rd Qu.: 98.06   3rd Qu.: 1.0000   54     : 136  \n#>  Max.   :192.91   Max.   :10.9817   29     : 135  \n#>                                     (Other):9038\n```\n:::\n\n```{.r .cell-code}\nmodel_cem <- lm(avg_purch ~ card, data = data_cem)\nsummary(model_cem)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> \n#> Call:\n#> lm(formula = avg_purch ~ card, data = data_cem)\n#> \n#> Residuals:\n#>      Min       1Q   Median       3Q      Max \n#> -100.835  -20.456   -0.178   20.041  119.973 \n#> \n#> Coefficients:\n#>             Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept)  66.1326     0.3934  168.11   <2e-16 ***\n#> card         24.3461     0.6060   40.18   <2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Residual standard error: 29.74 on 9878 degrees of freedom\n#> Multiple R-squared:  0.1405,\tAdjusted R-squared:  0.1404 \n#> F-statistic:  1614 on 1 and 9878 DF,  p-value: < 2.2e-16\n```\n:::\n:::\n\n\n## Apply Coarsed Matching Method with curpoints\n\n\n::: {.cell hash='07_matching_cache/html/unnamed-chunk-6_2ac9dcb9f9dab0af049dc7f4df5daa07'}\n\n```{.r .cell-code}\nlibrary(MatchIt)\ncutpoints <- list(age = seq(16, 85, 10), \n                  pre_avg_purch = seq(0, 160, 20))\nmatch_cem <- matchit(card ~ sex + age + pre_avg_purch, data = membership, method = \"cem\", cutpoints = cutpoints)\nsummary(match_cem)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> \n#> Call:\n#> matchit(formula = card ~ sex + age + pre_avg_purch, data = membership, \n#>     method = \"cem\", cutpoints = cutpoints)\n#> \n#> Summary of Balance for All Data:\n#>               Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean\n#> sex                  0.5087        0.5002          0.0171          .    0.0086\n#> age                 42.0331       39.1574          0.2064     1.1524    0.0438\n#> pre_avg_purch       76.3938       66.0438          0.3936     1.0276    0.1092\n#>               eCDF Max\n#> sex             0.0086\n#> age             0.0864\n#> pre_avg_purch   0.1545\n#> \n#> Summary of Balance for Matched Data:\n#>               Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean\n#> sex                  0.5095        0.5095          0.0000          .    0.0000\n#> age                 41.9593       41.8825          0.0055     1.0203    0.0024\n#> pre_avg_purch       76.1990       75.5617          0.0242     1.0038    0.0064\n#>               eCDF Max Std. Pair Dist.\n#> sex             0.0000          0.0000\n#> age             0.0092          0.2317\n#> pre_avg_purch   0.0185          0.2486\n#> \n#> Sample Sizes:\n#>               Control Treated\n#> All           5768.      4232\n#> Matched (ESS) 4704.04    4214\n#> Matched       5750.      4214\n#> Unmatched       18.        18\n#> Discarded        0.         0\n```\n:::\n\n```{.r .cell-code}\ndata_cem <- match.data(match_cem)\nsummary(data_cem)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#>       age             sex         pre_avg_purch           card       \n#>  Min.   :16.00   Min.   :0.0000   Min.   :  0.3307   Min.   :0.0000  \n#>  1st Qu.:29.80   1st Qu.:0.0000   1st Qu.: 51.8799   1st Qu.:0.0000  \n#>  Median :38.70   Median :1.0000   Median : 70.1684   Median :0.0000  \n#>  Mean   :40.34   Mean   :0.5036   Mean   : 70.4465   Mean   :0.4229  \n#>  3rd Qu.:49.10   3rd Qu.:1.0000   3rd Qu.: 88.6960   3rd Qu.:1.0000  \n#>  Max.   :90.00   Max.   :1.0000   Max.   :158.5457   Max.   :1.0000  \n#>                                                                      \n#>    avg_purch         weights          subclass   \n#>  Min.   :-28.61   Min.   :0.1516   9      : 422  \n#>  1st Qu.: 54.11   1st Qu.:0.8676   2      : 419  \n#>  Median : 76.27   Median :1.0000   1      : 415  \n#>  Mean   : 76.64   Mean   :1.0000   4      : 407  \n#>  3rd Qu.: 98.47   3rd Qu.:1.0000   32     : 405  \n#>  Max.   :192.91   Max.   :6.1402   45     : 392  \n#>                                    (Other):7504\n```\n:::\n\n```{.r .cell-code}\nmodel_cem <- lm(avg_purch ~ card, data = data_cem)\nsummary(model_cem)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> \n#> Call:\n#> lm(formula = avg_purch ~ card, data = data_cem)\n#> \n#> Residuals:\n#>      Min       1Q   Median       3Q      Max \n#> -101.330  -20.623   -0.241   20.317  119.975 \n#> \n#> Coefficients:\n#>             Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept)  66.1307     0.3946  167.58   <2e-16 ***\n#> card         24.8434     0.6068   40.94   <2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Residual standard error: 29.92 on 9962 degrees of freedom\n#> Multiple R-squared:  0.144,\tAdjusted R-squared:  0.1439 \n#> F-statistic:  1676 on 1 and 9962 DF,  p-value: < 2.2e-16\n```\n:::\n:::\n\n\n-   Adding cutpoints, did not seem to make much difference to the balance between the treatment and the control group indicating the treatment effect between the treatment and the control group. But this could also be due the the selection of the cutpoints. In this case, it was chosen to be **age** and **pre_avg_purch** might not have strong impact on the membership program.\n\n## Apply nearest neighbour matching Method\n\n\n::: {.cell hash='07_matching_cache/html/unnamed-chunk-7_fad7315f7e8117b1a8cef94359471528'}\n\n```{.r .cell-code}\nmatch_nn <- matchit(card ~ age + sex + pre_avg_purch, data = membership, method = \"nearest\", distance = \"mahalanobis\", replace = T)\nsummary(match_nn)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> \n#> Call:\n#> matchit(formula = card ~ age + sex + pre_avg_purch, data = membership, \n#>     method = \"nearest\", distance = \"mahalanobis\", replace = T)\n#> \n#> Summary of Balance for All Data:\n#>               Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean\n#> age                 42.0331       39.1574          0.2064     1.1524    0.0438\n#> sex                  0.5087        0.5002          0.0171          .    0.0086\n#> pre_avg_purch       76.3938       66.0438          0.3936     1.0276    0.1092\n#>               eCDF Max\n#> age             0.0864\n#> sex             0.0086\n#> pre_avg_purch   0.1545\n#> \n#> Summary of Balance for Matched Data:\n#>               Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean\n#> age                 42.0331       41.9964          0.0026     1.0171    0.0014\n#> sex                  0.5087        0.5087          0.0000          .    0.0000\n#> pre_avg_purch       76.3938       76.2937          0.0038     1.0178    0.0012\n#>               eCDF Max Std. Pair Dist.\n#> age             0.0061          0.0281\n#> sex             0.0000          0.0000\n#> pre_avg_purch   0.0076          0.0301\n#> \n#> Sample Sizes:\n#>               Control Treated\n#> All           5768.      4232\n#> Matched (ESS) 1992.19    4232\n#> Matched       2677.      4232\n#> Unmatched     3091.         0\n#> Discarded        0.         0\n```\n:::\n\n```{.r .cell-code}\ndata_nn <- match.data(match_nn)\nsummary(data_nn)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#>       age             sex         pre_avg_purch          card       \n#>  Min.   :16.20   Min.   :0.0000   Min.   : -3.966   Min.   :0.0000  \n#>  1st Qu.:30.80   1st Qu.:0.0000   1st Qu.: 56.368   1st Qu.:0.0000  \n#>  Median :39.90   Median :1.0000   Median : 74.441   Median :1.0000  \n#>  Mean   :41.51   Mean   :0.5086   Mean   : 74.705   Mean   :0.6125  \n#>  3rd Qu.:50.60   3rd Qu.:1.0000   3rd Qu.: 92.900   3rd Qu.:1.0000  \n#>  Max.   :90.00   Max.   :1.0000   Max.   :169.416   Max.   :1.0000  \n#>    avg_purch         weights      \n#>  Min.   :-23.40   Min.   :0.6326  \n#>  1st Qu.: 62.22   1st Qu.:1.0000  \n#>  Median : 83.73   Median :1.0000  \n#>  Mean   : 83.79   Mean   :1.0000  \n#>  3rd Qu.:105.06   3rd Qu.:1.0000  \n#>  Max.   :192.91   Max.   :5.0605\n```\n:::\n\n```{.r .cell-code}\nmodel_nn <- lm(avg_purch ~ card, data = data_nn)\nsummary(model_nn)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> \n#> Call:\n#> lm(formula = avg_purch ~ card, data = data_nn)\n#> \n#> Residuals:\n#>      Min       1Q   Median       3Q      Max \n#> -101.515  -20.666   -0.065   20.493  113.958 \n#> \n#> Coefficients:\n#>             Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept)  72.1472     0.5807  124.24   <2e-16 ***\n#> card         19.0120     0.7420   25.62   <2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Residual standard error: 30.05 on 6907 degrees of freedom\n#> Multiple R-squared:  0.0868,\tAdjusted R-squared:  0.08667 \n#> F-statistic: 656.5 on 1 and 6907 DF,  p-value: < 2.2e-16\n```\n:::\n:::\n\n\n## Apply inverse probability weightning matching Method\n\n::: {.cell hash='07_matching_cache/html/unnamed-chunk-8_1741963d61cb509af7287d6bd08e71a6'}\n\n```{.r .cell-code}\npropensity_model <- glm(card ~ age + sex + pre_avg_purch, family = binomial(link = \"logit\"), data = membership)\nsummary(propensity_model)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> \n#> Call:\n#> glm(formula = card ~ age + sex + pre_avg_purch, family = binomial(link = \"logit\"), \n#>     data = membership)\n#> \n#> Coefficients:\n#>                 Estimate Std. Error z value Pr(>|z|)    \n#> (Intercept)   -1.4298676  0.0752043 -19.013   <2e-16 ***\n#> age            0.0011486  0.0017761   0.647    0.518    \n#> sex            0.0359388  0.0412622   0.871    0.384    \n#> pre_avg_purch  0.0148262  0.0009264  16.003   <2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> (Dispersion parameter for binomial family taken to be 1)\n#> \n#>     Null deviance: 13626  on 9999  degrees of freedom\n#> Residual deviance: 13249  on 9996  degrees of freedom\n#> AIC: 13257\n#> \n#> Number of Fisher Scoring iterations: 4\n```\n:::\n\n```{.r .cell-code}\nmembership$propensity <- predict(propensity_model, type = \"response\")\nsummary(membership$propensity)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#>  0.1705  0.3534  0.4192  0.4232  0.4886  0.7695\n```\n:::\n\n```{.r .cell-code}\nmembership$ipw <- with(membership, (card / propensity) + ((1 - card) / (1 - propensity)))\nsummary(membership$ipw)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#>   1.206   1.611   1.871   2.000   2.256   5.308\n```\n:::\n\n```{.r .cell-code}\nmodel_ipw <- lm(avg_purch ~ card, data = membership, weights = ipw)\nsummary(model_ipw)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> \n#> Call:\n#> lm(formula = avg_purch ~ card, data = membership, weights = ipw)\n#> \n#> Weighted Residuals:\n#>      Min       1Q   Median       3Q      Max \n#> -205.353  -28.995   -0.275   28.787  214.307 \n#> \n#> Coefficients:\n#>             Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept)  70.2628     0.4320  162.66   <2e-16 ***\n#> card         14.9573     0.6109   24.48   <2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Residual standard error: 43.19 on 9998 degrees of freedom\n#> Multiple R-squared:  0.05657,\tAdjusted R-squared:  0.05647 \n#> F-statistic: 599.5 on 1 and 9998 DF,  p-value: < 2.2e-16\n```\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\r\n<script src=\"../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}